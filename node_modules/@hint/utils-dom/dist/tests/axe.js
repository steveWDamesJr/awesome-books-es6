"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ava_1 = require("ava");
const proxyquire = require("proxyquire");
const src_1 = require("../src");
const globals_1 = require("../src/globals");
const runAxe = async (html, rule) => {
    const doc = src_1.createHTMLDocument(html, 'http://localhost');
    globals_1.populateGlobals(global, doc);
    proxyquire('axe-core', {});
    const axe = global.axe;
    const results = await axe.run(document, {
        runOnly: {
            type: 'rule',
            values: [rule]
        }
    });
    delete global.axe;
    return results;
};
const testAxe = async (t, { pass, fail }) => {
    const rule = t.title;
    const passResults = await runAxe(pass, rule);
    const failResults = await runAxe(fail, rule);
    t.log(passResults.violations[0]);
    t.log(failResults);
    t.is(failResults.violations.length, 1);
    t.is(failResults.violations[0].id, rule);
    t.is(passResults.violations.length, 0);
};
ava_1.default.serial('aria-hidden-focus', async (t) => {
    await testAxe(t, {
        fail: '<p tabindex="0" aria-hidden="true">test</p>',
        pass: '<p aria-hidden="true">test</p>'
    });
});
ava_1.default.serial('document-title', async (t) => {
    await testAxe(t, {
        fail: '<title></title>',
        pass: '<title>test</title>'
    });
});
ava_1.default.serial('duplicate-id', async (t) => {
    await testAxe(t, {
        fail: '<div id="foo"></div><div id="foo"></div>',
        pass: '<div id="foo"></div><div id="bar"></div>'
    });
});
ava_1.default.serial('frame-title', async (t) => {
    await testAxe(t, {
        fail: '<iframe>',
        pass: '<iframe title="test">'
    });
});
ava_1.default.serial('html-has-lang', async (t) => {
    await testAxe(t, {
        fail: '<html>',
        pass: '<html lang="foo">'
    });
});
ava_1.default.serial('html-lang-valid', async (t) => {
    await testAxe(t, {
        fail: '<html lang="foo">',
        pass: '<html lang="en">'
    });
});
ava_1.default.serial('html-xml-lang-mismatch', async (t) => {
    await testAxe(t, {
        fail: '<html lang="en" xml:lang="fr">',
        pass: '<html lang="en" xml:lang="en">'
    });
});
ava_1.default.serial('image-alt', async (t) => {
    await testAxe(t, {
        fail: '<img src="foo">',
        pass: '<img alt="description" src="foo">'
    });
});
ava_1.default.serial('label', async (t) => {
    await testAxe(t, {
        fail: '<label>Name</label><input id="name">',
        pass: '<label for="name">Name</label><input id="name">'
    });
});
ava_1.default.serial('link-name', async (t) => {
    await testAxe(t, {
        fail: '<a href="#"></a>',
        pass: '<a href="#">Read more</a>'
    });
});
ava_1.default.serial('list', async (t) => {
    await testAxe(t, {
        fail: '<ul>test</ul>',
        pass: '<ul><li>test</li></ul>'
    });
});
ava_1.default.serial('listitem', async (t) => {
    await testAxe(t, {
        fail: '<html><li>test</li></html>',
        pass: '<ul><li>test</li></ul>'
    });
});
